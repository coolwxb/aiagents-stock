# 提示词工程与管理

<cite>
**本文档引用文件**  
- [ai_agents.py](file://backend/app/agents/ai_agents.py)
- [deepseek_client.py](file://backend/app/agents/deepseek_client.py)
- [stock_agents.py](file://backend/app/agents/stock_agents.py)
- [sector_agents.py](file://backend/app/agents/sector_agents.py)
- [longhubang_agents.py](file://backend/app/agents/longhubang_agents.py)
- [mainforce_agents.py](file://backend/app/agents/mainforce_agents.py)
- [config.py](file://backend/app/core/config.py)
- [security.py](file://backend/app/core/security.py)
</cite>

## 目录
1. [引言](#引言)
2. [提示词设计原则](#提示词设计原则)
3. [领域专用代理的提示词模板](#领域专用代理的提示词模板)
4. [多轮对话上下文管理](#多轮对话上下文管理)
5. [安全防护机制](#安全防护机制)
6. [提示词版本管理与A/B测试](#提示词版本管理与ab测试)
7. [结论](#结论)

## 引言

本系统采用多智能体架构，通过多个领域专用代理（如股票、板块、龙虎榜、主力选股等）协同工作，实现对股票市场的全面分析。每个代理都基于DeepSeek大模型，通过精心设计的提示词（prompt）来引导模型生成专业、准确的分析结果。提示词工程是系统的核心，决定了分析的质量和可靠性。

系统通过`ai_agents.py`中的`StockAnalysisAgents`类组织多个分析智能体，包括技术面、基本面、资金面、风险管理、市场情绪和新闻分析等。这些智能体通过`deepseek_client.py`调用DeepSeek API，执行具体的分析任务。提示词的设计不仅包括角色设定和分析要求，还包含上下文注入、输出格式约束等要素，确保生成的分析报告具有专业性和一致性。

**Section sources**
- [ai_agents.py](file://backend/app/agents/ai_agents.py)
- [deepseek_client.py](file://backend/app/agents/deepseek_client.py)

## 提示词设计原则

### 角色设定

每个智能体在提示词中都有明确的角色设定，这决定了模型的“身份”和“专业领域”。角色设定通常在system message中定义，为模型提供一个清晰的分析视角。

例如，在`deepseek_client.py`中，技术面分析智能体的角色设定为：
```python
{"role": "system", "content": "你是一名经验丰富的股票技术分析师，具有深厚的技术分析功底。"}
```

而基本面分析智能体的角色设定则为：
```python
{"role": "system", "content": "你是一名经验丰富的股票基本面分析师，擅长公司财务分析和行业研究。"}
```

这种明确的角色设定确保了模型能够以专业分析师的视角进行思考，避免了通用模型可能产生的泛泛而谈。

### 上下文注入

上下文注入是提示词工程的关键，它将实时的、具体的业务数据注入到提示词中，使模型的分析基于真实数据而非空泛的假设。

系统通过多种方式注入上下文：
- **股票基本信息**：代码、名称、价格、市值等。
- **财务数据**：ROE、ROA、毛利率、净利率等财务比率。
- **技术指标**：MA、RSI、MACD、布林带等。
- **外部数据**：资金流向、市场情绪、新闻、风险事件等。

例如，在资金面分析中，系统会将从akshare获取的近20个交易日的资金流向数据格式化后注入提示词：
```python
fund_flow_section = f"""
【近20个交易日资金流向详细数据】
{fetcher.format_fund_flow_for_ai(fund_flow_data)}
"""
```

这种数据注入方式确保了分析的客观性和准确性。

### 输出格式约束

为了便于后续处理和展示，系统对智能体的输出格式进行了严格约束。

在最终投资决策环节，系统明确要求模型以JSON格式输出决策结果：
```python
"""
请以JSON格式输出决策结果，格式如下：
{
    "rating": "买入/持有/卖出",
    "target_price": "目标价位数字",
    ...
}
"""
```

这种结构化输出使得前端可以轻松解析并展示关键决策信息，如评级、目标价、止盈止损位等。

**Section sources**
- [deepseek_client.py](file://backend/app/agents/deepseek_client.py#L93-L94)
- [deepseek_client.py](file://backend/app/agents/deepseek_client.py#L234-L235)
- [deepseek_client.py](file://backend/app/agents/deepseek_client.py#L424-L436)

## 领域专用代理的提示词模板

### 股票分析代理 (stock)

股票分析代理是系统的核心，它整合了多个维度的分析。其提示词模板设计为多阶段分析流程。

首先，各个专业分析师（技术、基本面、资金面等）并行生成各自的分析报告。然后，通过`conduct_team_discussion`方法进行团队讨论，模拟投资决策会议。

团队讨论的提示词构建了真实的会议场景：
```python
discussion_prompt = f"""
现在进行投资决策团队会议，参会人员包括：{', '.join(participants)}。
股票：{stock_info.get('name', 'N/A')} ({stock_info.get('symbol', 'N/A')})

各分析师报告：
{all_reports}

请模拟一场真实的投资决策会议讨论：
1. 各分析师观点的一致性和分歧
2. 不同维度分析的权重考量
...
"""
```

这种设计鼓励模型进行思辨和综合，而非简单拼接。

**Section sources**
- [ai_agents.py](file://backend/app/agents/ai_agents.py#L506-L525)

### 板块分析代理 (sector)

虽然`sector_agents.py`文件目前为空，但根据系统架构，板块分析代理应遵循类似的提示词设计原则。

它可能需要分析整个板块的走势、资金流向、市场情绪等，并与个股分析形成联动。其提示词模板应强调板块轮动、行业政策、宏观经济等宏观因素。

**Section sources**
- [sector_agents.py](file://backend/app/agents/sector_agents.py)

### 龙虎榜分析代理 (longhubang)

龙虎榜分析代理专注于解读交易所公布的龙虎榜数据，识别主力资金的动向。

其提示词应包含：
- 龙虎榜上榜原因（如涨跌幅、换手率等）
- 买卖席位的机构/营业部信息
- 买卖金额和占比
- 历史上榜记录对比

通过分析这些数据，代理可以判断是游资炒作还是机构建仓，为投资者提供决策参考。

**Section sources**
- [longhubang_agents.py](file://backend/app/agents/longhubang_agents.py)

### 主力选股代理 (mainforce)

主力选股代理旨在识别被主力资金持续关注的股票。

其提示词应强调：
- 主力资金净流入的持续性和强度
- 大单和超大单的成交占比
- 量价配合情况
- 与市场整体走势的对比

通过量化分析主力行为，代理可以筛选出具有上涨潜力的标的。

**Section sources**
- [mainforce_agents.py](file://backend/app/agents/mainforce_agents.py)

## 多轮对话上下文管理

系统通过`run_multi_agent_analysis`方法实现了多轮对话的上下文管理。

该方法支持动态选择参与分析的智能体，通过`enabled_analysts`参数控制分析流程：
```python
def run_multi_agent_analysis(self, ..., enabled_analysts: Dict = None):
    # 如果未指定，默认所有分析师都参与
    if enabled_analysts is None:
        enabled_analysts = {
            'technical': True,
            'fundamental': True,
            ...
        }
    ...
    # 并行运行各个分析师
    if enabled_analysts.get('technical', True):
        agents_results["technical"] = self.technical_analyst_agent(...)
```

这种设计实现了上下文的按需加载，避免了不必要的数据获取和计算，提高了分析效率。

此外，系统通过`session_state`在前端管理对话状态，确保用户可以连续进行多次分析而不会丢失上下文。

**Section sources**
- [ai_agents.py](file://backend/app/agents/ai_agents.py#L407-L468)
- [ai_agents.py](file://backend/app/agents/ai_agents.py#L442-L463)

## 安全防护机制

### 信息泄露防护

系统通过严格的配置管理来防止敏感信息泄露。

API密钥等敏感信息存储在`.env`文件中，并通过`config.py`加载：
```python
from app.config import settings
...
self.client = openai.OpenAI(
    api_key=settings.DEEPSEEK_API_KEY,
    base_url=settings.DEEPSEEK_BASE_URL
)
```

`.env`文件被加入`.gitignore`，确保不会提交到代码仓库。

**Section sources**
- [deepseek_client.py](file://backend/app/agents/deepseek_client.py#L12-L13)
- [config.py](file://backend/app/core/config.py)

### 提示词注入攻击防护

系统通过以下措施防范提示词注入攻击：

1. **输入验证**：对用户输入的股票代码等参数进行严格验证。
2. **上下文隔离**：每个智能体的提示词是独立构建的，避免恶意输入影响其他分析。
3. **内容过滤**：在将模型输出展示给用户前，进行必要的内容过滤和格式化。

例如，在`security.py`中，系统使用`passlib`库对用户密码进行哈希处理，确保认证安全：
```python
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
...
def verify_password(plain_password: str, hashed_password: str) -> bool:
    return pwd_context.verify(plain_password, hashed_password)
```

**Section sources**
- [security.py](file://backend/app/core/security.py)
- [deepseek_client.py](file://backend/app/agents/deepseek_client.py)

## 提示词版本管理与A/B测试

### 提示词版本管理

系统目前的提示词直接硬编码在`deepseek_client.py`中。为了实现更好的版本管理，建议将提示词模板外置为独立的配置文件。

例如，可以创建`prompts/`目录，将不同代理的提示词保存为JSON或YAML文件：
```
prompts/
  technical_analysis.json
  fundamental_analysis.json
  fund_flow_analysis.json
```

每个文件包含提示词的多个版本，通过版本号进行管理：
```json
{
  "version": "1.1",
  "system": "你是一名经验丰富的股票技术分析师...",
  "user_template": "请基于以下股票数据进行专业的技术面分析：..."
}
```

### A/B测试框架建议

建议构建一个A/B测试框架，用于评估不同提示词版本的效果。

1. **分流机制**：为用户分配唯一的`user_id`，根据`user_id`的哈希值决定使用哪个提示词版本。
2. **数据收集**：记录每次分析的输入、使用的提示词版本、模型输出、用户反馈等。
3. **效果评估**：通过人工评估或用户行为（如是否采纳建议）来衡量不同版本的效果。
4. **自动化迭代**：根据评估结果，自动选择表现最好的提示词版本作为默认版本。

这种A/B测试框架可以持续优化提示词，提升系统的分析质量。

**Section sources**
- [deepseek_client.py](file://backend/app/agents/deepseek_client.py)

## 结论

本系统的提示词工程实践体现了专业、系统化的设计思路。通过明确的角色设定、精准的上下文注入和严格的输出格式约束，确保了分析结果的专业性和一致性。多智能体协同和动态上下文管理机制，实现了高效、灵活的分析流程。同时，系统通过配置分离和输入验证等措施，保障了安全性。

未来，通过引入外置的提示词配置和A/B测试框架，可以进一步提升提示词的可维护性和优化效率，使系统能够持续进化，为用户提供更优质的分析服务。