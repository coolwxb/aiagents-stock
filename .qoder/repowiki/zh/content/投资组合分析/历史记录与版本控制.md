# å†å²è®°å½•ä¸ç‰ˆæœ¬æ§åˆ¶

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨æ–‡ä»¶**   
- [portfolio_db.py](file://backend/app/db/portfolio_db.py)
- [portfolio.py](file://backend/app/api/v1/portfolio.py)
- [portfolio_service.py](file://backend/app/services/portfolio_service.py)
- [history.vue](file://frontend/src/views/portfolio/history.vue)
- [portfolio.js](file://frontend/src/api/portfolio.js)
- [mainforce_batch_db.py](file://backend/app/db/mainforce_batch_db.py)
- [database.py](file://backend/app/database.py)
</cite>

## ç›®å½•
1. [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
2. [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
3. [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
4. [åç«¯APIå®ç°](#åç«¯apiå®ç°)
5. [å‰ç«¯å®ç°](#å‰ç«¯å®ç°)
6. [æ•°æ®ä¿ç•™ä¸ä¼˜åŒ–](#æ•°æ®ä¿ç•™ä¸ä¼˜åŒ–)

## é¡¹ç›®ç»“æ„

æŠ•èµ„ç»„åˆå†å²è®°å½•åŠŸèƒ½åˆ†å¸ƒåœ¨å‰åç«¯å¤šä¸ªæ¨¡å—ä¸­ï¼Œä¸»è¦æ¶‰åŠä»¥ä¸‹ç›®å½•ç»“æ„ï¼š

```mermaid
graph TB
subgraph "Backend"
A[app/api/v1/portfolio.py] --> B[app/services/portfolio_service.py]
B --> C[app/db/portfolio_db.py]
D[app/models/portfolio.py]
end
subgraph "Frontend"
E[src/views/portfolio/history.vue]
F[src/api/portfolio.js]
G[src/views/portfolio/components/PortfolioLayout.vue]
end
H[æ•°æ®åº“] --> C
E --> F
F --> A
```

**å›¾æº**
- [portfolio.py](file://backend/app/api/v1/portfolio.py)
- [history.vue](file://frontend/src/views/portfolio/history.vue)
- [PortfolioLayout.vue](file://frontend/src/views/portfolio/components/PortfolioLayout.vue)

## æ ¸å¿ƒç»„ä»¶

æŠ•èµ„ç»„åˆå†å²è®°å½•åŠŸèƒ½ç”±å‰åç«¯ååŒå®ç°ï¼Œä¸»è¦åŒ…æ‹¬æ•°æ®åº“å±‚ã€æœåŠ¡å±‚ã€APIå±‚å’Œå‰ç«¯UIå±‚ã€‚ç³»ç»Ÿé€šè¿‡åˆ†å±‚æ¶æ„ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ä¸æŸ¥è¯¢æ•ˆç‡ã€‚

**æœ¬èŠ‚æº**
- [portfolio_service.py](file://backend/app/services/portfolio_service.py)
- [portfolio.py](file://backend/app/api/v1/portfolio.py)
- [history.vue](file://frontend/src/views/portfolio/history.vue)

## æ•°æ®åº“è®¾è®¡

### æŠ•èµ„ç»„åˆå†å²è¡¨ç»“æ„

æ ¹æ®æ—§ç‰ˆä»£ç åˆ†æï¼ŒæŠ•èµ„ç»„åˆå†å²è®°å½•åŠŸèƒ½ä¾èµ–äºä¸¤ä¸ªæ ¸å¿ƒè¡¨ï¼š`portfolio_stocks`ï¼ˆæŒä»“è‚¡ç¥¨è¡¨ï¼‰å’Œ`portfolio_analysis_history`ï¼ˆæŒä»“åˆ†æå†å²è¡¨ï¼‰ã€‚

```mermaid
erDiagram
portfolio_stocks {
INTEGER id PK
TEXT code UK
TEXT name
REAL cost_price
INTEGER quantity
TEXT note
BOOLEAN auto_monitor
TIMESTAMP created_at
TIMESTAMP updated_at
}
portfolio_analysis_history {
INTEGER id PK
INTEGER portfolio_stock_id FK
TIMESTAMP analysis_time
TEXT rating
REAL confidence
REAL current_price
REAL target_price
REAL entry_min
REAL entry_max
REAL take_profit
REAL stop_loss
TEXT summary
}
portfolio_stocks ||--o{ portfolio_analysis_history : "1:N"
```

**å›¾æº**
- [portfolio_db.py](file://old/portfolio_db.py#L40-L73)

### æ•°æ®å­˜å‚¨ä¸åºåˆ—åŒ–

å†å²è®°å½•ä¸­çš„åˆ†æç»“æœé‡‡ç”¨JSONæ ¼å¼åºåˆ—åŒ–å­˜å‚¨ï¼Œç¡®ä¿å¤æ‚æ•°æ®ç»“æ„çš„å®Œæ•´ä¿å­˜ã€‚ç³»ç»Ÿé€šè¿‡`_clean_results_for_json`æ–¹æ³•æ¸…ç†æ•°æ®ï¼Œå¤„ç†DataFrameã€Seriesç­‰ç‰¹æ®Šç±»å‹ï¼Œé™åˆ¶æ•°æ®å¤§å°ä»¥é¿å…å­˜å‚¨è†¨èƒ€ã€‚

```python
def _clean_results_for_json(self, results: List[Dict]) -> List[Dict]:
    """
    æ¸…ç†ç»“æœæ•°æ®ï¼Œç¡®ä¿å¯ä»¥JSONåºåˆ—åŒ–
    
    Args:
        results: åŸå§‹ç»“æœåˆ—è¡¨
        
    Returns:
        æ¸…ç†åçš„ç»“æœåˆ—è¡¨
    """
    def clean_value(value):
        """é€’å½’æ¸…ç†å€¼"""
        if value is None:
            return None
        elif isinstance(value, pd.DataFrame):
            if len(value) > 100:
                return value.head(100).to_dict('records')
            return value.to_dict('records')
        elif isinstance(value, pd.Series):
            return value.to_dict()
        # ... å…¶ä»–ç±»å‹å¤„ç†
```

**æœ¬èŠ‚æº**
- [mainforce_batch_db.py](file://backend/app/db/mainforce_batch_db.py#L51-L78)
- [portfolio_db.py](file://old/portfolio_db.py)

### ç´¢å¼•ä¼˜åŒ–

ä¸ºæå‡æŸ¥è¯¢æ€§èƒ½ï¼Œç³»ç»Ÿåˆ›å»ºäº†å¤šä¸ªæ•°æ®åº“ç´¢å¼•ï¼š

- `idx_portfolio_analysis_stock_id`ï¼šåŸºäº`portfolio_stock_id`çš„ç´¢å¼•ï¼ŒåŠ é€Ÿç‰¹å®šè‚¡ç¥¨çš„å†å²è®°å½•æŸ¥è¯¢
- `idx_analysis_date`ï¼šåŸºäº`analysis_date`çš„ç´¢å¼•ï¼Œä¼˜åŒ–æŒ‰åˆ†ææ—¶é—´çš„æŸ¥è¯¢æ•ˆç‡
- `created_at`å­—æ®µä¸Šçš„ç´¢å¼•ï¼Œç¡®ä¿æŒ‰åˆ›å»ºæ—¶é—´æ’åºçš„æŸ¥è¯¢æ€§èƒ½

è¿™äº›ç´¢å¼•è®¾è®¡ç¡®ä¿äº†åœ¨å¤§æ•°æ®é‡ä¸‹çš„é«˜æ•ˆæŸ¥è¯¢èƒ½åŠ›ã€‚

**æœ¬èŠ‚æº**
- [mainforce_batch_db.py](file://backend/app/db/mainforce_batch_db.py#L44-L45)
- [portfolio_db.py](file://old/portfolio_db.py#L76-L78)

## åç«¯APIå®ç°

### APIç«¯ç‚¹è®¾è®¡

ç³»ç»Ÿæä¾›`GET /api/v1/portfolio/history`æ¥å£æ”¯æŒåˆ†é¡µæŸ¥è¯¢å†å²è®°å½•ï¼Œè¯¥æ¥å£æ”¯æŒä»¥ä¸‹å‚æ•°ï¼š

- `stock_code`ï¼šå¯é€‰ï¼ŒæŒ‰è‚¡ç¥¨ä»£ç è¿‡æ»¤
- `page`ï¼šå½“å‰é¡µç ï¼Œé»˜è®¤ä¸º1
- `page_size`ï¼šæ¯é¡µè®°å½•æ•°ï¼Œé»˜è®¤ä¸º20

```python
@router.get("/history")
async def get_history(
    stock_code: str = None,
    page: int = 1,
    page_size: int = 20,
    db: Session = Depends(get_database)
):
    """åˆ†æå†å²"""
    service = PortfolioService(db)
    try:
        result = await service.get_history(stock_code, page, page_size)
        return success_response(result)
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
```

**æœ¬èŠ‚æº**
- [portfolio.py](file://backend/app/api/v1/portfolio.py#L108-L123)

### æœåŠ¡å±‚å®ç°

`PortfolioService`ç±»çš„`get_history`æ–¹æ³•è´Ÿè´£å¤„ç†å†å²è®°å½•æŸ¥è¯¢é€»è¾‘ï¼ŒåŒ…æ‹¬åˆ†é¡µå¤„ç†å’Œæ•°æ®æ ¼å¼åŒ–ï¼š

```python
async def get_history(self, stock_code: Optional[str] = None, page: int = 1, page_size: int = 20):
    """åˆ†æå†å²"""
    # TODO: å®ç°åˆ†æå†å²æŸ¥è¯¢é€»è¾‘
    pass
```

åˆ†é¡µé€»è¾‘é‡‡ç”¨ç®€å•çš„åˆ‡ç‰‡æ–¹å¼å®ç°ï¼Œæ•°æ®åº“æŸ¥è¯¢ç»“æœå·²æŒ‰`created_at`é™åºæ’åˆ—ï¼š

```python
# ç®€å•åˆ†é¡µï¼ˆæ•°æ®åº“å·²æŒ‰created_at DESCæ’åºï¼‰
start_idx = (page - 1) * page_size
end_idx = start_idx + page_size
items = history[start_idx:end_idx]

return {
    "total": len(history),
    "page": page,
    "page_size": page_size,
    "items": items
}
```

**æœ¬èŠ‚æº**
- [portfolio_service.py](file://backend/app/services/portfolio_service.py#L49-L52)
- [mainforce_service.py](file://backend/app/services/mainforce_service.py#L220-L230)

### æ•°æ®å®Œæ•´æ€§ä¿éšœ

ç³»ç»Ÿé€šè¿‡ä»¥ä¸‹æœºåˆ¶ç¡®ä¿æ•°æ®å®Œæ•´æ€§ï¼š

1. **å¤–é”®çº¦æŸ**ï¼š`portfolio_analysis_history`è¡¨ä¸­çš„`portfolio_stock_id`å­—æ®µè®¾ç½®ä¸ºå¤–é”®ï¼Œå¼•ç”¨`portfolio_stocks`è¡¨çš„`id`å­—æ®µï¼Œå¹¶é…ç½®`ON DELETE CASCADE`ï¼Œç¡®ä¿åˆ é™¤æŒä»“è‚¡ç¥¨æ—¶è‡ªåŠ¨æ¸…ç†ç›¸å…³å†å²è®°å½•ã€‚

2. **äº‹åŠ¡å¤„ç†**ï¼šæ‰€æœ‰æ•°æ®åº“æ“ä½œåœ¨äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œç¡®ä¿æ“ä½œçš„åŸå­æ€§ã€‚

3. **æ•°æ®éªŒè¯**ï¼šåœ¨æœåŠ¡å±‚å¯¹è¾“å…¥å‚æ•°è¿›è¡ŒéªŒè¯ï¼Œé˜²æ­¢æ— æ•ˆæ•°æ®å†™å…¥æ•°æ®åº“ã€‚

4. **å¼‚å¸¸å¤„ç†**ï¼šå®Œå–„çš„å¼‚å¸¸æ•è·å’Œæ—¥å¿—è®°å½•æœºåˆ¶ï¼Œä¾¿äºé—®é¢˜è¿½è¸ªå’Œç³»ç»Ÿç»´æŠ¤ã€‚

**æœ¬èŠ‚æº**
- [portfolio_db.py](file://old/portfolio_db.py#L71-L72)
- [portfolio_service.py](file://backend/app/services/portfolio_service.py)

## å‰ç«¯å®ç°

### UIè®¾è®¡

`history.vue`ç»„ä»¶é€šè¿‡`PortfolioLayout`ç»„ä»¶çš„"åˆ†æå†å²"æ ‡ç­¾é¡µå±•ç¤ºå†å²è®°å½•ï¼Œé‡‡ç”¨æ—¶é—´è½´ï¼ˆTimelineï¼‰å¸ƒå±€å±•ç¤ºåˆ†æå†å²ï¼Œæ¯ä¸ªæ—¶é—´ç‚¹æ˜¾ç¤ºè‚¡ç¥¨ä»£ç ã€åç§°ã€è¯„çº§ã€ä¿¡å¿ƒåº¦åŠå…³é”®ä»·æ ¼ä¿¡æ¯ã€‚

```vue
<el-tab-pane label="ğŸ“ˆ åˆ†æå†å²" name="history">
  <el-card shadow="never" class="section-card">
    <div class="section-header">
      <h3>å†å²è®°å½•</h3>
      <div class="header-actions">
        <el-button icon="el-icon-refresh" :loading="historyLoading" @click="loadHistory">
          åˆ·æ–°
        </el-button>
      </div>
    </div>
    <el-form :inline="true" size="small" class="history-toolbar">
      <!-- æœç´¢æ¡† -->
    </el-form>
    <el-timeline v-else>
      <el-timeline-item
        v-for="record in filteredHistory"
        :key="record.id"
        :timestamp="formatDate(record.analysis_time)"
        placement="top"
      >
        <!-- å†å²è®°å½•å¡ç‰‡ -->
      </el-timeline-item>
    </el-timeline>
    <div v-if="showHistoryPagination" class="pagination-wrapper">
      <el-pagination
        layout="prev, pager, next"
        :current-page="historyPagination.page"
        :page-size="historyPagination.page_size"
        :total="historyPagination.total"
        @current-change="handleHistoryPageChange"
      />
    </div>
  </el-card>
</el-tab-pane>
```

**æœ¬èŠ‚æº**
- [history.vue](file://frontend/src/views/portfolio/history.vue#L324-L405)
- [PortfolioLayout.vue](file://frontend/src/views/portfolio/components/PortfolioLayout.vue#L324-L405)

### äº¤äº’é€»è¾‘

å‰ç«¯é€šè¿‡`portfolio.js`ä¸­çš„`getPortfolioHistory`å‡½æ•°è°ƒç”¨åç«¯APIè·å–å†å²è®°å½•ï¼š

```javascript
// åˆ†æå†å²
export function getPortfolioHistory(params) {
  return request({
    url: '/api/v1/portfolio/history',
    method: 'get',
    params
  })
}
```

ç”¨æˆ·äº¤äº’é€»è¾‘åŒ…æ‹¬ï¼š

1. **åˆ†é¡µæµè§ˆ**ï¼šé€šè¿‡`el-pagination`ç»„ä»¶å®ç°åˆ†é¡µåŠŸèƒ½ï¼Œæ”¯æŒå‰åç¿»é¡µã€‚
2. **æœç´¢è¿‡æ»¤**ï¼šæä¾›æœç´¢æ¡†ï¼Œæ”¯æŒæŒ‰è‚¡ç¥¨ä»£ç æˆ–åç§°è¿‡æ»¤å†å²è®°å½•ã€‚
3. **å®æ—¶åˆ·æ–°**ï¼šæä¾›åˆ·æ–°æŒ‰é’®ï¼Œå¯æ‰‹åŠ¨é‡æ–°åŠ è½½å†å²è®°å½•ã€‚
4. **æ—¶é—´æ’åº**ï¼šå†å²è®°å½•æŒ‰åˆ†ææ—¶é—´å€’åºæ’åˆ—ï¼Œæœ€æ–°è®°å½•æ˜¾ç¤ºåœ¨æœ€ä¸Šæ–¹ã€‚

**æœ¬èŠ‚æº**
- [portfolio.js](file://frontend/src/api/portfolio.js#L64-L72)
- [PortfolioLayout.vue](file://frontend/src/views/portfolio/components/PortfolioLayout.vue#L751-L788)

## æ•°æ®ä¿ç•™ä¸ä¼˜åŒ–

### æ•°æ®ä¿ç•™ç­–ç•¥

ç³»ç»Ÿé‡‡ç”¨ä»¥ä¸‹æ•°æ®ä¿ç•™ç­–ç•¥ï¼š

1. **æœ‰é™å­˜å‚¨**ï¼šé€šè¿‡`limit`å‚æ•°é™åˆ¶è¿”å›çš„å†å²è®°å½•æ•°é‡ï¼Œé»˜è®¤ä¸º50æ¡ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½è¿‡å¤šæ•°æ®å½±å“æ€§èƒ½ã€‚

2. **æŒ‰éœ€åŠ è½½**ï¼šé‡‡ç”¨åˆ†é¡µæœºåˆ¶ï¼ŒåªåŠ è½½å½“å‰é¡µæ‰€éœ€æ•°æ®ï¼Œå‡å°‘ç½‘ç»œä¼ è¾“é‡ã€‚

3. **æ•°æ®æ¸…ç†**ï¼šæä¾›åˆ é™¤æ¥å£ï¼Œæ”¯æŒæ¸…ç†è¿‡æœŸæˆ–æ— ç”¨çš„å†å²è®°å½•ã€‚

### å­˜å‚¨ç©ºé—´ä¼˜åŒ–

ä¸ºä¼˜åŒ–å­˜å‚¨ç©ºé—´ï¼Œç³»ç»Ÿé‡‡å–ä»¥ä¸‹æªæ–½ï¼š

1. **æ•°æ®å‹ç¼©**ï¼šå¯¹DataFrameç­‰å¤§æ•°æ®å¯¹è±¡ï¼Œåªä¿ç•™å‰100è¡Œï¼Œé¿å…å­˜å‚¨è¿‡å¤§ã€‚

2. **ç´¢å¼•ä¼˜åŒ–**ï¼šåˆ›å»ºå¿…è¦çš„æ•°æ®åº“ç´¢å¼•ï¼Œæå‡æŸ¥è¯¢æ•ˆç‡ï¼Œå‡å°‘å…¨è¡¨æ‰«æã€‚

3. **æ•°æ®å½’æ¡£**ï¼šè™½ç„¶å½“å‰ä»£ç æœªå®ç°ï¼Œä½†å¯é€šè¿‡å®šæœŸå½’æ¡£æ—§æ•°æ®åˆ°å†·å­˜å‚¨æ¥ä¼˜åŒ–ä¸»æ•°æ®åº“æ€§èƒ½ã€‚

4. **ç¼“å­˜æœºåˆ¶**ï¼šå‰ç«¯å¯¹å†å²è®°å½•è¿›è¡Œç¼“å­˜ï¼Œå‡å°‘é‡å¤è¯·æ±‚ã€‚

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **æ•°æ®åº“åˆ†åŒº**ï¼šå¯¹å†å²è®°å½•è¡¨æŒ‰æ—¶é—´åˆ†åŒºï¼Œæå‡æŸ¥è¯¢æ€§èƒ½ã€‚
2. **å¼‚æ­¥å¤„ç†**ï¼šå°†å†å²è®°å½•æŸ¥è¯¢æ”¹ä¸ºå¼‚æ­¥ä»»åŠ¡ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚
3. **ç¼“å­˜å±‚**ï¼šå¼•å…¥Redisç­‰ç¼“å­˜ç³»ç»Ÿï¼Œç¼“å­˜å¸¸ç”¨æŸ¥è¯¢ç»“æœã€‚
4. **æ•°æ®å‹ç¼©**ï¼šå¯¹JSONæ•°æ®è¿›è¡ŒGZIPå‹ç¼©å­˜å‚¨ï¼Œå‡å°‘å­˜å‚¨ç©ºé—´å ç”¨ã€‚

**æœ¬èŠ‚æº**
- [mainforce_batch_db.py](file://backend/app/db/mainforce_batch_db.py#L66-L68)
- [portfolio_db.py](file://old/portfolio_db.py)