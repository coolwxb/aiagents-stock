# 前端代理问题排查指南

## 问题描述
前端服务无法通过代理访问后端API

## 已修复的配置

### 1. 前端代理配置 (`frontend/vue.config.js`)
```javascript
proxy: {
  '/dev-api': {
    target: 'http://127.0.0.1:8000',  // ✅ 使用 127.0.0.1 替代 localhost
    changeOrigin: true,
    pathRewrite: { '^/dev-api': '' }, // ✅ 移除 /dev-api，保留 /api/v1
    ws: true,
    logLevel: 'debug',  // ✅ 新增：调试日志
    onProxyReq(proxyReq, req, res) {
      console.log(`[Proxy] ${req.method} ${req.url} -> ${proxyReq.path}`)
    },
    onError(err, req, res) {
      console.error('Proxy error:', err)
    }
  }
}
```

### 2. 后端CORS配置 (`backend/app/config.py`)
```python
CORS_ORIGINS: List[str] = [
    "http://localhost:8000",
    "http://localhost:9528",  # ✅ 新增：Vue前端开发服务器
    "http://127.0.0.1:8000",
    "http://127.0.0.1:9528",
    "http://localhost:3000"
]
```

## 请求路径流程

1. **前端API调用**：`/api/v1/monitor/tasks`
2. **Axios baseURL**：`/dev-api`
3. **实际请求URL**：`/dev-api/api/v1/monitor/tasks`
4. **代理处理**：
   - 匹配规则：`/dev-api`
   - 目标地址：`http://127.0.0.1:8000`
   - 路径重写：`/dev-api/api/v1/monitor/tasks` → `/api/v1/monitor/tasks`
5. **最终请求**：`http://127.0.0.1:8000/api/v1/monitor/tasks` ✅

## 启动服务步骤

### 1. 启动后端服务
```bash
cd d:\project\量化\aiagents-stock\backend
.\start_server.bat
```
确认输出：
```
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
INFO:     Started reloader process
INFO:     Started server process
INFO:     Waiting for application startup.
INFO:     Application startup complete.
```

### 2. 测试后端API
在浏览器访问：
- http://127.0.0.1:8000/ （根路径）
- http://127.0.0.1:8000/health （健康检查）
- http://127.0.0.1:8000/api/docs （API文档）

### 3. 启动前端服务
```bash
cd d:\project\量化\aiagents-stock\frontend
npm run dev
```
确认输出：
```
DONE  Compiled successfully in XXXXms
App running at:
- Local:   http://localhost:9528/
- Network: http://xxx.xxx.xxx.xxx:9528/
```

## 故障排查步骤

### 检查1：后端是否启动
```bash
# PowerShell
Test-NetConnection 127.0.0.1 -Port 8000
```
✅ 期望：`TcpTestSucceeded : True`

### 检查2：前端代理日志
打开浏览器开发者工具 Console，查看代理日志：
```
[Proxy] GET /dev-api/api/v1/monitor/tasks -> /api/v1/monitor/tasks
```

### 检查3：网络请求
在 Network 标签页查看：
- **Request URL**: `http://localhost:9528/dev-api/api/v1/monitor/tasks`
- **Status**: 应为 `200` 或其他正常状态码
- **如果是 404**: 后端路由未配置
- **如果是 CORS错误**: 检查CORS配置
- **如果是 ERR_CONNECTION_REFUSED**: 后端未启动

### 检查4：后端日志
查看后端控制台输出：
```
INFO:     127.0.0.1:xxxxx - "GET /api/v1/monitor/tasks HTTP/1.1" 200 OK
```

## 常见问题解决

### 问题1: ERR_CONNECTION_REFUSED
**原因**：后端服务未启动
**解决**：
```bash
cd backend
.\start_server.bat
```

### 问题2: CORS错误
**错误信息**：
```
Access to XMLHttpRequest at 'http://127.0.0.1:8000/api/v1/monitor/tasks' 
from origin 'http://localhost:9528' has been blocked by CORS policy
```
**解决**：已在 `backend/app/config.py` 中添加 `http://localhost:9528`

### 问题3: 404 Not Found
**原因**：路径不匹配
**检查**：
1. 前端API路径：`/api/v1/monitor/tasks`
2. 代理重写后：`/api/v1/monitor/tasks`
3. 后端路由：`/api/v1/monitor/tasks`
4. 确认后端路由已注册

### 问题4: localhost vs 127.0.0.1
**问题**：某些情况下 `localhost` 可能解析失败
**解决**：统一使用 `127.0.0.1`

## 验证代理是否正常

### 方法1：浏览器控制台
```javascript
// 在浏览器控制台执行
fetch('/dev-api/health')
  .then(r => r.json())
  .then(console.log)
```
✅ 期望输出：`{code: 200, message: "success", data: {status: "healthy"}}`

### 方法2：Vue组件中测试
```javascript
import request from '@/utils/request'

request.get('/health').then(res => {
  console.log('后端连接正常:', res)
})
```

## 重启服务顺序

当修改配置后，请按以下顺序重启：

1. **停止后端** (Ctrl+C)
2. **停止前端** (Ctrl+C)
3. **启动后端** (`.\start_server.bat`)
4. **等待后端完全启动** (看到 "Application startup complete")
5. **启动前端** (`npm run dev`)
6. **清除浏览器缓存** (Ctrl+Shift+Delete 或 硬刷新 Ctrl+Shift+R)

## 调试技巧

### 1. 启用详细日志
前端已启用 `logLevel: 'debug'`，查看控制台输出

### 2. 使用 Postman 测试后端
直接测试后端API：
```
GET http://127.0.0.1:8000/api/v1/monitor/tasks
```

### 3. 检查防火墙
确保 8000 和 9528 端口未被防火墙阻止

## 成功标志

✅ 浏览器控制台无 CORS 错误
✅ 浏览器控制台有代理日志 `[Proxy] GET /dev-api/...`
✅ Network 标签显示请求成功 (200 状态码)
✅ 前端页面能正常获取数据
